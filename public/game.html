<!doctype html>
<html lang="en">
  <head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><title>Arena - Game</title><link rel="stylesheet" href="/styles.css" /><link rel="stylesheet" href="/ui.css" /></head>
  <body class="arena-page arcade-mode">
    <header id="hud" class="hud"></header>
    <main class="arcade-main"><div class="panel panel--main"><nav></nav>
      <h1>Arcade Hub</h1>
      <div class="game-layout arcade-grid hub-grid">
        <div class="card inner gladiator-card arcade-frame"><img id="gladiatorGif" src="/assets/gladiator.gif" alt="Gladiator animation" class="gladiator-gif" /><div id="gladiatorFallback" class="gladiator-fallback hidden">Gladiator enters soon.</div></div>
        <div>
          <div class="stat-grid compact-stats chip-grid">
            <div class="card inner"><strong>Stats</strong><div id="stats">-</div></div>
            <div class="card inner"><strong>Health</strong><div id="wound">-</div></div>
            <div class="card inner"><strong>Fame</strong><div id="fame">-</div></div>
          </div>
          <section id="trainingLogPanel" class="card inner training-log-panel" aria-live="polite"><h3>Training Log</h3><ul id="trainingLogList" class="training-log-list"><li class="muted">No training yet.</li></ul></section>
        </div>
      </div>
      <p id="lastResult" class="muted">No recent action.</p><div id="resultsPanel" class="results-panel hidden"></div>
      <div id="shareBox" class="card inner hidden"><p><strong>Share Link</strong></p><input id="shareLink" readonly /><button id="copyShareBtn">Copy</button></div>
      <p id="error" class="error"></p>
      <button class="hidden" data-action-btn id="trainBtn">Train</button><button class="hidden" data-action-btn id="restBtn">Rest</button><button class="hidden" data-action-btn id="fightAiBtn">Fight AI</button><button class="hidden" data-action-btn id="postChallengeBtn">Post Challenge</button>
    </div></main>
    <footer id="actionBar" class="action-bar"></footer>

    <script src="/api.js"></script><script src="/audio.js"></script><script src="/ui.js"></script><script src="/app.js"></script>
    <script>
      App.renderNav();
      let run = null; const TRAINING_LOG_LIMIT = 5; const gameState = { trainingLog: [] };
      function getGameStateKey() { return `arenaGameState:${Api.getRunId() || 'default'}`; }
      function loadGameState() { try { const parsed = JSON.parse(localStorage.getItem(getGameStateKey()) || '{}') || {}; gameState.trainingLog = Array.isArray(parsed.trainingLog) ? parsed.trainingLog : []; } catch { gameState.trainingLog = []; } }
      function persistGameState() { localStorage.setItem(getGameStateKey(), JSON.stringify({ trainingLog: gameState.trainingLog })); }
      function appendTrainingLogEntry(entry) { gameState.trainingLog.unshift(entry); gameState.trainingLog = gameState.trainingLog.slice(0, TRAINING_LOG_LIMIT); persistGameState(); renderTrainingLog(); }
      function renderTrainingLog() { const list = document.getElementById('trainingLogList'); list.innerHTML = gameState.trainingLog.length ? gameState.trainingLog.map((e)=>{ const action = (e && typeof e.action === 'string' && e.action.trim()) ? e.action.trim() : 'Train'; const result = (e && typeof e.result === 'string' && e.result.trim()) ? e.result.trim() : 'No result'; return `<li class="training-log-entry"><span class="training-log-result">${action}: ${result}</span></li>`; }).join('') : '<li class="muted">No training yet.</li>'; }
      function ensureSession() { if (!Api.getRunId() || !Api.getPlayerId()) { location.href = '/index.html'; return false; } return true; }
      function setResult(text) { document.getElementById('lastResult').textContent = text; }
      function updateActionBar() {
        const hasGladiator = !!(run?.roster && run.roster.length);
        const lowHp = run?.wound === 'serious';
        UI.setActionBar([
          { label: hasGladiator ? 'FIGHT AI' : 'RECRUIT', target: hasGladiator ? '#fightAiBtn' : null, href: hasGladiator ? null : '/recruit.html', className: `btn btn--primary btn--fight ${(!lowHp && hasGladiator) ? 'is-recommended' : ''}`, disabled: !hasGladiator || run.turns <= 0 },
          { label: 'TRAIN', target: '#trainBtn', className: 'btn btn--secondary btn--minor' },
          { label: 'REST', target: '#restBtn', className: `btn btn--secondary btn--minor ${lowHp ? 'is-recommended' : ''}` },
          { label: 'POST CHALLENGE', target: '#postChallengeBtn', className: 'btn btn--tertiary btn--tertiary-small' }
        ]);
      }
      function renderRun() {
        ['wound','fame'].forEach((k)=>document.getElementById(k).textContent = run[k]);
        document.getElementById('stats').textContent = App.formatStats(run.stats); UI.setRun(run); App.disableActions(run.turns <= 0); updateActionBar(); if (App.runEnded(run)) location.href = '/summary.html';
      }
      async function loadRun() { run = await Api.getRun(); if (!run) { location.href = '/index.html'; return; } renderRun(); }
      function renderResultsPanel(title, changes) { const panel = document.getElementById('resultsPanel'); panel.classList.remove('hidden'); panel.innerHTML = `<h3>${title}</h3><p>${changes}</p><div class="row"><button class="btn btn--primary" id="nextFight">FIGHT AGAIN</button><button class="btn btn--secondary" id="nextTrain">TRAIN</button><button class="btn btn--secondary" id="nextRest">REST</button></div>`; panel.querySelector('#nextFight').onclick = ()=>document.getElementById('fightAiBtn').click(); panel.querySelector('#nextTrain').onclick = ()=>document.getElementById('trainBtn').click(); panel.querySelector('#nextRest').onclick = ()=>document.getElementById('restBtn').click(); }
      async function doTrain(){ Api.clearError(); App.disableActions(true); try { await App.showActionOverlay({ title:'Training...', gifPath:'/assets/train.gif', durationMs: 1800 }); const data = await Api.request(`/api/run/${Api.getRunId()}/action/train`, { method:'POST', headers: Api.jsonHeaders(), body: JSON.stringify({ playerId: Api.getPlayerId() }) }); run = data.run; renderRun(); const m={STR:'Strength',AGI:'Agility',END:'Endurance'}; const improved=m[data.statImproved]||'Stat'; appendTrainingLogEntry({ action:'Train', result:`+1 ${improved}`}); setResult(`Training complete. +1 ${improved}.`);} catch (e){Api.showError(e);} finally { App.disableActions(run ? run.turns<=0 : false);} }
      document.getElementById('trainBtn').addEventListener('click', doTrain);
      document.getElementById('gladiatorGif').addEventListener('error', () => { document.getElementById('gladiatorGif').classList.add('hidden'); document.getElementById('gladiatorFallback').classList.remove('hidden'); });
      document.getElementById('restBtn').addEventListener('click', async () => { Api.clearError(); App.disableActions(true); try { await App.showActionOverlay({ title:'Resting...', gifPath:'/assets/rest.gif', durationMs: 1500 }); const data = await Api.request(`/api/run/${Api.getRunId()}/action/rest`, { method:'POST', headers: Api.jsonHeaders(), body: JSON.stringify({ playerId: Api.getPlayerId() }) }); run = data.run; renderRun(); setResult('Rest completed.'); } catch (e) { Api.showError(e); } finally { App.disableActions(run ? run.turns<=0 : false);} });
      document.getElementById('fightAiBtn').addEventListener('click', async () => { Api.clearError(); App.disableActions(true); try { const data = await Api.request(`/api/run/${Api.getRunId()}/action/fightAI`, { method:'POST', headers: Api.jsonHeaders(), body: JSON.stringify({ playerId: Api.getPlayerId(), difficulty:'normal' }) }); const playback = await App.showFightPlayback({ leftGif:'/assets/fight-left.gif', rightGif:'/assets/fight-right.gif', leftName: localStorage.getItem('arenaGladiatorName') || 'You', rightName:'Arena AI', durationMs: 18000, rewards: { gold: data.fight.gold || 0, fame: data.fight.fame || 0 }, fightResult: data.fight, onSkip: ()=>setResult('Combat playback skipped.') }); run = data.run; renderRun(); const status = data.fight.result === 'win' ? 'VICTORY' : 'DEFEAT'; renderResultsPanel(status, `Injury: ${data.fight.injury}`); if (playback && playback.overlayOutcome && playback.authoritativeOutcome && playback.overlayOutcome !== playback.authoritativeOutcome) { console.error('Fight UI mismatch detected', { authoritative: playback.authoritativeOutcome, overlay: playback.overlayOutcome, fight: data.fight, playback }); } } catch (e) { Api.showError(e); } finally { App.disableActions(run ? run.turns<=0 : false);} });
      document.getElementById('postChallengeBtn').addEventListener('click', async () => { try { const data = await Api.request(`/api/run/${Api.getRunId()}/challenge/post`, { method:'POST', headers: Api.jsonHeaders(), body: JSON.stringify({ playerId: Api.getPlayerId() }) }); run = data.run; renderRun(); document.getElementById('shareLink').value = `${location.origin}/challenge/${encodeURIComponent(data.challengeId)}`; document.getElementById('shareBox').classList.remove('hidden'); } catch (e) { Api.showError(e); } });
      document.getElementById('copyShareBtn').addEventListener('click', async () => { try { await Api.copyText(document.getElementById('shareLink').value); } catch {} });
      window.__debugFightOnce = async function __debugFightOnce() {
        if (!ensureSession()) return { ok: false, reason: 'no-session' };
        const before = await Api.getRun();
        const data = await Api.request(`/api/run/${Api.getRunId()}/action/fightAI`, { method:'POST', headers: Api.jsonHeaders(), body: JSON.stringify({ playerId: Api.getPlayerId(), difficulty:'normal' }) });
        const playback = await App.showFightPlayback({ leftGif:'/assets/fight-left.gif', rightGif:'/assets/fight-right.gif', leftName: localStorage.getItem('arenaGladiatorName') || 'You', rightName:'Arena AI', durationMs: 2500, rewards: { gold: data.fight.gold || 0, fame: data.fight.fame || 0 }, fightResult: data.fight });
        run = data.run;
        renderRun();
        const expected = data.fight.result;
        const displayed = playback && playback.overlayOutcome ? playback.overlayOutcome : null;
        const outcomeMatches = displayed === expected;
        const summary = {
          authoritativeOutcome: expected,
          authoritativeFinalHp: { player: expected === 'win' ? '>0' : '0-or-low', opponent: expected === 'win' ? '0-or-low' : '>0' },
          overlayDisplayedOutcome: displayed,
          overlayHp: playback ? { player: playback.leftHp, opponent: playback.rightHp } : null,
          winsBefore: before ? before.wins : null,
          winsAfter: run.wins,
          lossesBefore: before ? before.losses : null,
          lossesAfter: run.losses,
          recordMatchesOutcome: expected === 'win' ? run.wins === ((before && before.wins) || 0) + 1 : run.losses === ((before && before.losses) || 0) + 1,
          outcomeMatches
        };
        console.log('[__debugFightOnce] summary', summary);
        if (!summary.outcomeMatches || !summary.recordMatchesOutcome) {
          console.error('[__debugFightOnce] mismatch detected', { summary, fight: data.fight, playback });
        }
        return summary;
      };
      (async function init(){ if (!ensureSession()) return; loadGameState(); renderTrainingLog(); await loadRun(); if (localStorage.getItem('arenaInstantFight') === 'true') { localStorage.removeItem('arenaInstantFight'); setTimeout(() => document.getElementById('fightAiBtn').click(), 150); } })();
    </script>
  </body>
</html>
