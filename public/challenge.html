<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Arena - Challenge</title>
    <link rel="stylesheet" href="/styles.css" />
    <link rel="stylesheet" href="/ui.css" />
  </head>
  <body class="arena-page">
    <main>
      <nav></nav>

      <section class="card panel">
        <h1>Challenge</h1>
        <label>
          Challenge ID:
          <input id="challengeIdInput" />
        </label>
        <div class="row">
          <button class="btn-secondary" id="loadChallengeBtn">Load Challenge</button>
          <button class="btn-primary" id="acceptBtn" disabled>Accept (cost 1 turn)</button>
        </div>

        <div id="challengeView" class="card inner">No challenge loaded.</div>
        <p id="result" class="muted"></p>
        <p id="error" class="error"></p>
      </section>
    </main>

    <script src="/api.js"></script>
    <script src="/audio.js"></script>
    <script src="/ui.js"></script>
    <script src="/app.js"></script>
    <script>
      App.renderNav();

      function challengeIdFromUrl() {
        const params = new URLSearchParams(location.search);
        const fromQuery = params.get('id') || params.get('challengeId') || '';
        if (fromQuery) return fromQuery;

        const match = location.pathname.match(/^\/challenge\/([^/]+)$/);
        return match ? decodeURIComponent(match[1]) : '';
      }

      function setChallengeView(data) {
        const box = document.getElementById('challengeView');
        box.innerHTML = '';

        if (data.challenge.status === 'OPEN') {
          box.innerHTML = `
            <p><strong>Status:</strong> OPEN</p>
            <p><strong>Creator Snapshot:</strong> ${App.formatStats(data.challenge.creatorSnapshot.stats)}</p>
            <p><strong>Creator Rating:</strong> ${data.challenge.creatorSnapshot.rating.toFixed(1)}</p>
            <p><strong>Expires:</strong> ${data.challenge.expiresAt}</p>
          `;
          document.getElementById('acceptBtn').disabled = false;
          return;
        }

        document.getElementById('acceptBtn').disabled = true;
        if (data.challenge.status === 'RESOLVED') {
          box.innerHTML = `
            <p><strong>Status:</strong> RESOLVED</p>
            <p><strong>Winner Run:</strong> ${data.challenge.result.winnerRunId}</p>
            <p><strong>Loser Run:</strong> ${data.challenge.result.loserRunId}</p>
          `;
          return;
        }

        box.innerHTML = '<p><strong>Status:</strong> EXPIRED</p><p>This challenge has expired.</p>';
      }

      async function loadChallenge() {
        Api.clearError();
        const id = document.getElementById('challengeIdInput').value.trim();
        if (!id) return;

        try {
          const data = await Api.request(`/api/challenge/${encodeURIComponent(id)}`);
          setChallengeView(data);
        } catch (error) {
          Api.showError(error);
        }
      }

      document.getElementById('loadChallengeBtn').addEventListener('click', loadChallenge);

      document.getElementById('acceptBtn').addEventListener('click', async () => {
        Api.clearError();
        const challengeId = document.getElementById('challengeIdInput').value.trim();
        const runId = Api.getRunId();
        const playerId = Api.getPlayerId();

        if (!runId || !playerId) {
          location.href = '/index.html';
          return;
        }

        document.getElementById('acceptBtn').disabled = true;
        try {
          const data = await Api.request(`/api/challenge/${encodeURIComponent(challengeId)}/accept`, {
            method: 'POST',
            headers: Api.jsonHeaders(),
            body: JSON.stringify({ runId, playerId })
          });

          await App.showFightPlayback({
            leftGif: '/assets/fight-left.gif',
            rightGif: '/assets/fight-right.gif',
            durationMs: 30000,
            onSkip: () => {
              document.getElementById('result').textContent = 'Combat playback skipped.';
            }
          });

          document.getElementById('result').textContent = `Winner run: ${data.result.winnerRunId}. Injury: ${data.result.injury}`;
          setChallengeView({ challenge: data.challenge });

          if (App.runEnded(data.accepterRun)) {
            location.href = '/summary.html';
          }
        } catch (error) {
          Api.showError(error);
          document.getElementById('acceptBtn').disabled = false;
        }
      });

      (function init() {
        const id = challengeIdFromUrl();
        document.getElementById('challengeIdInput').value = id;
        Api.getRun().then((run) => run && UI.setRun(run)).catch(() => {});
        if (id) loadChallenge();
      })();
    </script>
  </body>
</html>
