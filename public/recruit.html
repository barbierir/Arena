<!doctype html>
<html lang="en">
  <head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><title>Arena - Recruit</title><link rel="stylesheet" href="/styles.css" /><link rel="stylesheet" href="/ui.css" /></head>
  <body class="arena-page arcade-mode">
    <header id="hud" class="hud"></header>
    <main class="arcade-main"><div class="panel panel--main"><nav></nav>
      <h1>Recruit Gladiator</h1>
      <p><strong>Turns:</strong> <span id="turns">-</span> | <strong>Gold:</strong> <span id="gold">-</span></p>
      <div class="recruit-layout arcade-grid">
        <div class="recruit-gif-wrap"><img id="recruitGif" src="/assets/recruit-1.gif" alt="Recruit animation" /></div>
        <div id="candidateCard" class="card inner candidate-card">No candidate yet.</div>
      </div>
      <p id="error" class="error"></p>
    </div></main>
    <footer id="actionBar" class="action-bar"></footer>

    <script src="/api.js"></script><script src="/audio.js"></script><script src="/ui.js"></script><script src="/app.js"></script>
    <script>
      App.renderNav();
      let run = null; let currentCandidate = null; let buyInFlight = false;
      UI.setActionBar([
        { label: 'GENERATE', target: '#generateBtn', className: 'btn--primary-arcade' },
        { label: 'BUY', target: '#buyBtn', className: 'btn--primary-arcade', id: 'arcadeBuyBtn', disabled: true },
        { label: 'SKIP', target: '#skipBtn', className: 'btn-secondary' }
      ]);

      function ensureSession() { if (!Api.getRunId() || !Api.getPlayerId()) { location.href = '/index.html'; return false; } return true; }
      function swapRecruitGif() { document.getElementById('recruitGif').src = App.pickRandomRecruitGif(); }
      function setActionDisabled(disabled) { ['generateBtn','skipBtn'].forEach((id)=>document.getElementById(id).disabled = disabled); if (disabled) document.getElementById('buyBtn').disabled = true; syncActionBar(); }
      function syncActionBar(){ const buyArcade=document.getElementById('arcadeBuyBtn'); if (buyArcade) buyArcade.disabled = document.getElementById('buyBtn').disabled; }
      function renderRun() { document.getElementById('turns').textContent = run.turns; document.getElementById('gold').textContent = run.gold; UI.setRun(run); setActionDisabled(run.turns <= 0); if (App.runEnded(run)) location.href = '/summary.html'; }
      function renderCandidate() {
        const card = document.getElementById('candidateCard'); const buyBtn = document.getElementById('buyBtn');
        if (!currentCandidate) { card.textContent = 'No candidate yet.'; buyBtn.disabled = true; syncActionBar(); return; }
        const s = currentCandidate.stats;
        card.innerHTML = `<h3>${currentCandidate.name}</h3><p>STR <span id="strN">0</span> / AGI <span id="agiN">0</span> / END <span id="endN">0</span> / Talent <span id="talN">0</span></p><p><strong>Trait:</strong> <span class="trait-pill">${UI.traitFromStats(s)}</span></p><p><strong>Price:</strong> ${currentCandidate.price} | <strong>Rating:</strong> ${currentCandidate.rating.toFixed(1)}</p>`;
        ['STR','AGI','END','Talent'].forEach((k,i)=>UI.animateCount(card.querySelector(['#strN','#agiN','#endN','#talN'][i]),0,s[k],600));
        buyBtn.disabled = buyInFlight; syncActionBar();
      }
      async function refreshRun() { run = await Api.getRun(); if (!run) { location.href = '/index.html'; return; } renderRun(); }
      function announce(msg){ const o=document.createElement('div'); o.className='recruit-intro'; o.textContent=msg; document.querySelector('.recruit-gif-wrap').appendChild(o); setTimeout(()=>o.remove(),1000); }

      document.body.insertAdjacentHTML('beforeend','<button id="generateBtn" class="hidden"></button><button id="skipBtn" class="hidden"></button><button id="buyBtn" class="hidden" disabled></button>');

      document.getElementById('generateBtn').addEventListener('click', async () => { Api.clearError(); swapRecruitGif(); announce('NEW CHALLENGER!'); try { const data = await Api.request(`/api/run/${Api.getRunId()}/recruit/generate`, { method:'POST', headers: Api.jsonHeaders(), body: JSON.stringify({ playerId: Api.getPlayerId() }) }); currentCandidate = data.candidate; renderCandidate(); await refreshRun(); } catch (error) { Api.showError(error);} });
      document.getElementById('skipBtn').addEventListener('click', async () => { Api.clearError(); swapRecruitGif(); try { const data = await Api.request(`/api/run/${Api.getRunId()}/recruit/skip`, { method:'POST', headers: Api.jsonHeaders(), body: JSON.stringify({ playerId: Api.getPlayerId() }) }); run = data.run; currentCandidate = data.candidate; renderRun(); renderCandidate(); } catch (error) { Api.showError(error);} });
      document.getElementById('buyBtn').addEventListener('click', async () => { Api.clearError(); if (buyInFlight || !currentCandidate) return; buyInFlight = true; document.getElementById('buyBtn').disabled = true; syncActionBar(); try { const c = currentCandidate; const data = await Api.request(`/api/run/${Api.getRunId()}/recruit/buy`, { method:'POST', headers: Api.jsonHeaders(), body: JSON.stringify({ playerId: Api.getPlayerId(), candidateId: c.id }) }); run = data.run; currentCandidate = null; localStorage.setItem('arenaGladiatorName', (data.candidate || c).name || 'Gladiator'); renderRun(); renderCandidate(); announce('RECRUITED!'); setTimeout(()=>{ location.href = '/game.html'; }, 600);} catch (error) { buyInFlight = false; renderCandidate(); Api.showError(error);} });

      (async function init(){ if (!ensureSession()) return; await refreshRun(); swapRecruitGif(); })();
    </script>
  </body>
</html>
