<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Arena - Recruit</title>
    <link rel="stylesheet" href="/styles.css" />
    <link rel="stylesheet" href="/ui.css" />
  </head>
  <body class="arena-page">
    <main>
      <nav></nav>

      <section class="card panel">
        <h1>Recruit Gladiator</h1>
        <p><strong>Turns:</strong> <span id="turns">-</span> | <strong>Gold:</strong> <span id="gold">-</span></p>
        <div class="row">
          <button class="btn-primary" id="generateBtn">Generate</button>
          <button class="btn-secondary" id="skipBtn">Skip (cost 1 turn)</button>
          <button class="btn-primary" id="buyBtn" disabled>Buy</button>
        </div>

        <div class="recruit-layout">
          <div class="recruit-gif-wrap">
            <img id="recruitGif" src="/assets/recruit-1.gif" alt="Recruit animation" />
          </div>
          <div id="candidateCard" class="card inner">No candidate yet.</div>
        </div>

        <p id="error" class="error"></p>
      </section>
    </main>

    <script src="/api.js"></script>
    <script src="/audio.js"></script>
    <script src="/ui.js"></script>
    <script src="/app.js"></script>
    <script>
      App.renderNav();
      let run = null;
      let currentCandidate = null;

      function ensureSession() {
        if (!Api.getRunId() || !Api.getPlayerId()) {
          location.href = '/index.html';
          return false;
        }
        return true;
      }

      function swapRecruitGif() {
        document.getElementById('recruitGif').src = App.pickRandomRecruitGif();
      }

      function setActionDisabled(disabled) {
        document.getElementById('generateBtn').disabled = disabled;
        document.getElementById('skipBtn').disabled = disabled;
        if (disabled) document.getElementById('buyBtn').disabled = true;
      }

      function renderRun() {
        document.getElementById('turns').textContent = run.turns;
        document.getElementById('gold').textContent = run.gold;
        UI.setRun(run);
        setActionDisabled(run.turns <= 0);
        if (App.runEnded(run)) {
          location.href = '/summary.html';
        }
      }

      function renderCandidate() {
        const card = document.getElementById('candidateCard');
        const buyBtn = document.getElementById('buyBtn');
        if (!currentCandidate) {
          card.textContent = 'No candidate yet.';
          buyBtn.disabled = true;
          return;
        }

        card.innerHTML = `
          <h3>${currentCandidate.name}</h3>
          <p>${App.formatStats(currentCandidate.stats)}</p>
          <p><strong>Trait:</strong> ${UI.traitFromStats(currentCandidate.stats)}</p>
          <p><strong>Price:</strong> ${currentCandidate.price}</p>
          <p class="muted">Rating ${currentCandidate.rating.toFixed(1)}</p>
        `;
        const s = currentCandidate.stats;
        const reduced = UI.getSettings().reduceMotion;
        UI.animateCount(card.querySelector('h3'), 0, 0, 0, true);
        card.querySelector('p').innerHTML = `STR <span id="strN">0</span> / AGI <span id="agiN">0</span> / END <span id="endN">0</span> / Talent <span id="talN">0</span>`;
        UI.animateCount(card.querySelector('#strN'), 0, s.STR, 700, reduced);
        UI.animateCount(card.querySelector('#agiN'), 0, s.AGI, 700, reduced);
        UI.animateCount(card.querySelector('#endN'), 0, s.END, 700, reduced);
        UI.animateCount(card.querySelector('#talN'), 0, s.Talent, 700, reduced);
        buyBtn.disabled = false;
      }

      async function refreshRun() {
        run = await Api.getRun();
        if (!run) {
          location.href = '/index.html';
          return;
        }
        renderRun();
      }

      document.getElementById('generateBtn').addEventListener('click', async () => {
        Api.clearError();
        swapRecruitGif();
        try {
          const data = await Api.request(`/api/run/${Api.getRunId()}/recruit/generate`, {
            method: 'POST',
            headers: Api.jsonHeaders(),
            body: JSON.stringify({ playerId: Api.getPlayerId() })
          });
          currentCandidate = data.candidate;
          renderCandidate();
          await refreshRun();
          UI.showToast('New Challenger arrived!', 'success');
        } catch (error) {
          Api.showError(error);
        }
      });

      document.getElementById('skipBtn').addEventListener('click', async () => {
        Api.clearError();
        swapRecruitGif();
        try {
          const data = await Api.request(`/api/run/${Api.getRunId()}/recruit/skip`, {
            method: 'POST',
            headers: Api.jsonHeaders(),
            body: JSON.stringify({ playerId: Api.getPlayerId() })
          });
          run = data.run;
          currentCandidate = data.candidate;
          renderRun();
          renderCandidate();
        } catch (error) {
          Api.showError(error);
        }
      });

      document.getElementById('buyBtn').addEventListener('click', async () => {
        Api.clearError();
        if (!currentCandidate) return;
        try {
          const data = await Api.request(`/api/run/${Api.getRunId()}/recruit/buy`, {
            method: 'POST',
            headers: Api.jsonHeaders(),
            body: JSON.stringify({ playerId: Api.getPlayerId(), candidateId: currentCandidate.id })
          });
          run = data.run;
          currentCandidate = null;
          localStorage.setItem('arenaGladiatorName', data.candidate.name);
          renderRun();
          renderCandidate();
          UI.showToast('Gladiator recruited', 'success');
          location.href = '/game.html';
        } catch (error) {
          Api.showError(error);
        }
      });

      (async function init() {
        if (!ensureSession()) return;
        try {
          await refreshRun();
          swapRecruitGif();
          const wrap = document.querySelector('.recruit-gif-wrap');
          const intro = document.createElement('div');
          intro.className = 'recruit-intro';
          intro.textContent = 'New Challenger';
          wrap.style.position = 'relative';
          wrap.appendChild(intro);
          setTimeout(() => intro.remove(), 1400);
        } catch (error) {
          Api.showError(error);
        }
      })();
    </script>
  </body>
</html>
